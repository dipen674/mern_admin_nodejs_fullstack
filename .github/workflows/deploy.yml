name: Docker MERN Stack CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

env:
  DOCKER_REPO: deependrabhatta/githubactions_mern
  FRONTEND_API_BASE_URL: /api/

jobs:
# -------------------
# 1. Build & Scan Backend
# -------------------
  build_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          no-cache: true
          tags: |
            ${{ env.DOCKER_REPO }}:backend-${{ env.TIMESTAMP }}-${{ github.sha }}
            ${{ env.DOCKER_REPO }}:backend-latest

      - name: Download Trivy HTML template
        run: wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O html.tpl

      - name: Generate Trivy HTML Report (Backend)
        run: |
          trivy image --format template --template "@html.tpl" \
            -o trivy-backend-report.html \
            ${{ env.DOCKER_REPO }}:backend-${{ env.TIMESTAMP }}-${{ github.sha }}

      - name: Upload Backend HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-backend-html
          path: trivy-backend-report.html

# -------------------
# 2. Build & Scan Frontend
# -------------------
  build_frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          no-cache: true
          tags: |
            ${{ env.DOCKER_REPO }}:frontend-${{ env.TIMESTAMP }}-${{ github.sha }}
            ${{ env.DOCKER_REPO }}:frontend-latest
          build-args: |
            REACT_APP_API_BASE_URL=${{ env.FRONTEND_API_BASE_URL }}

      - name: Download Trivy HTML template
        run: wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O html.tpl

      - name: Generate Trivy HTML Report (Frontend)
        run: |
          trivy image --format template --template "@html.tpl" \
            -o trivy-frontend-report.html \
            ${{ env.DOCKER_REPO }}:frontend-${{ env.TIMESTAMP }}-${{ github.sha }}

      - name: Upload Frontend HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-frontend-html
          path: trivy-frontend-report.html

# -------------------
# 3. Deploy to Testing (Docker Compose)
# -------------------
  deploy_testing:
    needs: [build_backend, build_frontend]
    runs-on: deployment_vm
    environment: staging
    steps:
      - name: Clear workspace
        run: sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Pull and Deploy with Docker Compose
        run: |
          DOCKER_REPO=${{ env.DOCKER_REPO }} IMAGE_TAG=${{ github.sha }} \
          docker compose -f docker-compose.yaml pull
          DOCKER_REPO=${{ env.DOCKER_REPO }} IMAGE_TAG=${{ github.sha }} \
          docker compose -f docker-compose.yaml up -d --force-recreate

# -------------------
# 4. Deploy to Minikube (Helm)
# -------------------
  # deploy_minikube:
  #   needs: [build_backend, build_frontend]
  #   runs-on: minikube
  #   environment: production
  #   steps:
  #     - name: Clear workspace
  #       run: rm -rf $GITHUB_WORKSPACE/*

  #     - name: Checkout Code
  #       uses: actions/checkout@v4
  #       with:
  #         clean: true

  #     - name: Cleanup old release
  #       run: |
  #         helm uninstall mern -n mern-test || true
  #         kubectl delete namespace mern-test --ignore-not-found=true

  #     - name: Fresh deploy with Helm
  #       run: |
  #         helm upgrade --install mern charts/mern-admin -n mern-test \
  #           --create-namespace \
  #           --set backend.image.repository="${{ env.DOCKER_REPO }}" \
  #           --set backend.image.tag="backend-${{ env.TIMESTAMP }}-${{ github.sha }}" \
  #           --set frontend.image.repository="${{ env.DOCKER_REPO }}" \
  #           --set frontend.image.tag="frontend-${{ env.TIMESTAMP }}-${{ github.sha }}" \
  #           --set backend.secrets.databaseUri="${{ secrets.DATABASE }}" \
  #           --set backend.secrets.jwtSecret="${{ secrets.JWT_SECRET }}" \
  #           --set backend.secrets.secret="${{ secrets.SECRET }}" \
  #           --set backend.secrets.key="${{ secrets.KEY }}"

# -------------------
# 5. Slack Notifications
# -------------------
  notify:
    needs: [deploy_testing]
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "âœ… MERN pipeline completed!\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nTimestamp: ${{ env.TIMESTAMP }}\nTrivy reports archived as HTML."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
