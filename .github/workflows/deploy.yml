name: Docker MERN Stack CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

env:
  DOCKER_REPO: deependrabhatta/githubactions_mern
  FRONTEND_API_BASE_URL: /api/

jobs:
# -------------------
# 1. Build & Scan Backend
# -------------------
  build_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build locally (not pushed yet)
      - name: Build Backend Image (local only)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          load: true
          tags: |
            backend-temp:latest

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Download Trivy HTML template
        run: wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O html.tpl

      # ✅ Fail pipeline if HIGH/CRITICAL vulnerabilities are found
      # - name: Trivy Scan with Severity Threshold
      #   run: |
      #     trivy image --severity HIGH,CRITICAL --exit-code 1 backend-temp:latest

      # Generate full HTML report (even if scan passes)
      - name: Generate Trivy HTML Report (Backend)
        run: |
          trivy image --format template --template "@html.tpl" \
            -o trivy-backend-report.html \
            backend-temp:latest

      - name: Upload Backend HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-backend-html
          path: trivy-backend-report.html

      # ✅ Only push if scan step succeeded
      - name: Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          no-cache: true
          tags: |
            ${{ env.DOCKER_REPO }}:backend-${{ env.TIMESTAMP }}-${{ github.sha }}
            ${{ env.DOCKER_REPO }}:backend-latest


# 2. Build & Scan Frontend

  build_frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build image locally (not pushed yet)
      - name: Build Frontend Image (local only)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          load: true
          tags: |
            frontend-temp:latest
          build-args: |
            REACT_APP_API_BASE_URL=${{ env.FRONTEND_API_BASE_URL }}

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Download Trivy HTML template
        run: wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O html.tpl

      # ✅ Fail pipeline if HIGH/CRITICAL vulnerabilities are found
      # - name: Trivy Scan with Severity Threshold
      #   run: |
      #     trivy image --severity HIGH,CRITICAL --exit-code 1 frontend-temp:latest

      # Generate full HTML report for visibility
      - name: Generate Trivy HTML Report (Frontend)
        run: |
          trivy image --format template --template "@html.tpl" \
            -o trivy-frontend-report.html \
            frontend-temp:latest

      - name: Upload Frontend HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-frontend-html
          path: trivy-frontend-report.html

      # ✅ Only push if scan step succeeded
      - name: Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          no-cache: true
          tags: |
            ${{ env.DOCKER_REPO }}:frontend-${{ env.TIMESTAMP }}-${{ github.sha }}
            ${{ env.DOCKER_REPO }}:frontend-latest
          build-args: |
            REACT_APP_API_BASE_URL=${{ env.FRONTEND_API_BASE_URL }}

# 3. Deploy to Testing (Docker Compose)
  deploy_testing:
    needs: [build_backend, build_frontend]
    runs-on: deployment_vm
    environment: staging
    steps:
      - name: Clear workspace
        run: sudo rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Pull and Deploy with Docker Compose
        run: |
          DOCKER_REPO=${{ env.DOCKER_REPO }} IMAGE_TAG=${{ github.sha }} \
          docker compose -f docker-compose.yaml pull
          DOCKER_REPO=${{ env.DOCKER_REPO }} IMAGE_TAG=${{ github.sha }} \
          docker compose -f docker-compose.yaml up -d --force-recreate

# -------------------
# 4. Publish Reports to GitHub Pages
# -------------------
  publish_reports:
    needs: [build_backend, build_frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4

      - name: Download Backend Report
        uses: actions/download-artifact@v4
        with:
          name: trivy-backend-html
          path: reports

      - name: Download Frontend Report
        uses: actions/download-artifact@v4
        with:
          name: trivy-frontend-html
          path: reports

      # ✅ Fetch index.html from gh-pages branch
      - name: Fetch index.html from gh-pages
        run: |
          git fetch origin gh-pages
          git checkout origin/gh-pages -- index.html
          cp index.html reports/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: reports



# -------------------
# 5. Deploy to Minikube (Helm)
# -------------------
  deploy_minikube:
    needs: [build_backend, build_frontend]
    runs-on: minikube
    environment: production
    steps:
      - name: Clear workspace
        run: rm -rf $GITHUB_WORKSPACE/*

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Cleanup old release
        run: |
          helm uninstall mern -n mern-test || true
          kubectl delete namespace mern-test --ignore-not-found=true

      - name: Fresh deploy with Helm
        run: |
          helm upgrade --install mern charts/mern-admin -n mern-test \
            --create-namespace \
            --set backend.secrets.databaseUri="${{ secrets.DATABASE }}" \
            --set backend.secrets.jwtSecret="${{ secrets.JWT_SECRET }}" \
            --set backend.secrets.secret="${{ secrets.SECRET }}" \
            --set backend.secrets.key="${{ secrets.KEY }}"

# 6. Slack Notifications
# Notifications for Testing

  notify_success_testing:
    needs: [deploy_testing, publish_reports]
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - name: Slack success (Testing)
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "✅ MERN pipeline (Testing) succeeded!\nWorkflow: ${{ github.workflow }}\nEvent: ${{ github.event_name }}\nTriggered by: ${{ github.actor }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nReports: https://dipen674.github.io/mern_admin_nodejs_fullstack"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_failure_testing:
    needs: [deploy_testing, publish_reports]
    runs-on: ubuntu-latest
    if: ${{ failure() }}
    steps:
      - name: Slack failure (Testing)
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "❌ MERN pipeline (Testing) failed!\nWorkflow: ${{ github.workflow }}\nEvent: ${{ github.event_name }}\nTriggered by: ${{ github.actor }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nLogs: https://github.com/dipen674/mern_admin_nodejs_fullstack/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Notifications for Minikube (manual approval flow)

  notify_success_minikube:
    needs: [deploy_minikube, publish_reports]
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - name: Slack success (Minikube)
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "✅ MERN pipeline (Minikube) succeeded!\nWorkflow: ${{ github.workflow }}\nEvent: ${{ github.event_name }}\nTriggered by: ${{ github.actor }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nReports: https://dipen674.github.io/mern_admin_nodejs_fullstack"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify_failure_minikube:
    needs: [deploy_minikube, publish_reports]
    runs-on: ubuntu-latest
    if: ${{ failure() }}
    steps:
      - name: Slack failure (Minikube)
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "❌ MERN pipeline (Minikube) failed!\nWorkflow: ${{ github.workflow }}\nEvent: ${{ github.event_name }}\nTriggered by: ${{ github.actor }}\nBranch: ${{ github.ref }}\nCommit: ${{ github.sha }}\nLogs: https://github.com/dipen674/mern_admin_nodejs_fullstack/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
